package com.iblancasa.comedoresugr;


import android.content.Context;
import android.os.AsyncTask;
import android.support.wearable.view.GridViewPager;
import android.util.Log;
import android.view.Gravity;
import android.support.wearable.view.FragmentGridPagerAdapter;

import org.jsoup.Connection;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;

import java.io.IOException;
import java.io.UnsupportedEncodingException;
import java.nio.charset.Charset;
import java.util.ArrayList;
import java.util.Calendar;

public class ParserComedor extends AsyncTask<String, Void, String> {

    private ArrayList<Dia> semana = new ArrayList<>();


    private Context contextoPadre;
    private GridViewPager gridViewPager;
    ArrayList<String> platosMenu;
    private FragmentManager fm;
	

    public ParserComedor(Context ctx, GridViewPager grid, FragmentManager fm){
        super();
        contextoPadre = ctx;
	gridViewPager = grid;
        fManager = fm;
       
    }


    @Override
    protected String doInBackground(String... strings) {

        Connection.Response response = null;
        try {
            response = Jsoup.connect(strings[0])
                    .userAgent("Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/535.21 (KHTML, like Gecko) Chrome/19.0.1042.0 Safari/535.21")
                    .execute();
        } catch (IOException e) {
            e.printStackTrace();
        }

        if(response!=null) {
            int statusCode = response.statusCode();

            if (statusCode == 200) {

                Document doc = null;
                try {
                    doc = response.parse();
                } catch (IOException e) {
                    e.printStackTrace();
                }

                Elements metaElems = doc.select("#plato");
                for (Element metaElem : metaElems) {

                    platosMenu = new ArrayList<>();

                    Charset utf8charset = Charset.forName("UTF-8");
                    Charset iso88591charset = Charset.forName("ISO-8859-1");

                    String diaplato  = metaElem.getElementById("diaplato").getElementById("fechaplato").text();


                    diaplato = diaplato.replaceAll("\\<.*?>","");
                    diaplato = diaplato.replaceAll(" +", " ");



                    Element menuDia = metaElem.getElementById("platos");
                    Elements platos = menuDia.children();

                    for (Element plato : platos) {
                        platosMenu.add(plato.html().replaceAll("\\<.*?>","").replaceAll(" +", " "));
                    }

                    Dia d = new Dia(diaplato, platosMenu);
                    semana.add(d);
                }
            }
            else{
                platosMenu = new ArrayList<>();
                platosMenu.add("No hay conexión");
                Dia d = new Dia("Algo falló",platosMenu);
                semana.add(d);

            }
        }
            else{
                    platosMenu = new ArrayList<>();
                    platosMenu.add("No hay conexión");
                    Dia d = new Dia("Algo falló",platosMenu);
                    semana.add(d);

                }

        return "";
    }

    @Override
    protected void onPreExecute() {
        super.onPreExecute();
    }

    @Override
    protected void onPostExecute(String s) {
        super.onPostExecute(s);

        Dia d = getHoy();
        ArrayList<String> platosHoy = d.getComida();

        if(platosHoy.size()==3) {//Todo ha ido bien
          Page[][] PAGES = {
		    {
		            new Page("Primer plato",platosHoy.get(0), R.drawable.bugdroid,
		                    Gravity.CENTER_VERTICAL),
		    },
		    {
		            new Page("Segundo plato", platosHoy.get(0), R.drawable.bugdroid,
		                    Gravity.CENTER_VERTICAL),
		    },
 		    {
		            new Page("Otros", platosHoy.get(0), R.drawable.bugdroid,
		                    Gravity.CENTER_VERTICAL),
		    }
	    };
        }
        else{//Ha fallado
            Page[][] PAGES = {
		    {
		            new Page("Error","Algo salió mal", R.drawable.bugdroid,
		                    Gravity.CENTER_VERTICAL),
		    }
		  
	    };
        }
       gridViewPager.setAdapter(new SampleGridPagerAdapter(contextoPadre, fm,platosHoy));

    }

    public Dia getHoy(){

        if(semana.size()!=1) {

            Calendar rightNow = Calendar.getInstance();
            String dia;

            switch (rightNow.get(Calendar.DAY_OF_WEEK)) {
                case Calendar.MONDAY:
                    dia = "Lunes";
                    break;
                case Calendar.TUESDAY:
                    dia = "Martes";
                    break;
                case Calendar.WEDNESDAY:
                    dia = "Miércoles";
                    break;
                case Calendar.THURSDAY:
                    dia = "Jueves";
                    break;
                case Calendar.FRIDAY:
                    dia = "Viernes";
                    break;
                case Calendar.SATURDAY:
                    dia = "Sábado";
                    break;
                default:
                    return null;
            }

            for (int i = 0; i < semana.size(); i++) {
                if (semana.get(i).getDia().contains(dia)) {
                    return semana.get(i);
                }
            }
        }
        else if(semana.size()==1) {
            return semana.get(0);
        }

        return null;

    }


}



